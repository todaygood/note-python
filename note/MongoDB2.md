# MongoDB 如何设计数据结构?

有人说MonoDb可以使用一个collection , 把所有数据放在一张表里面，真的有道理吗？ 

[MongoDB 倾向于将数据都放在一个 Collection 下吗？]{https://segmentfault.com/q/1010000000589390}


Collection 的单个 doc 有大小上限，现在是 16MB，这就使得你不可能把所有东西都揉到一个 collection 里。而且如果 collection 结构过于复杂，既会影响查询、更新效率，也会造成维护困难和操作风险。你有尝试过手一抖就把一个 doc 不小心存成 null 的么，反正我做过，要是一个人所有信息都在这个 collection 里面，那感觉一定相当酸爽吧。

一般的原则是：

按照查询方式来聚类

需要经常一起读取的数据放一起.
在逻辑上关系紧密的信息放在一起。
有 map-reduce/aggregation 需求的数据放在一起，这些操作都只能操作单个 collection。
按照数据量来拆分

如果发现要在 collection 里面用数组，数组长度还会不断增加，那么应该把数据内容放到一个专门的 collection，每条数据都引用当前这个 doc 的主键（就像 mysql 的 1..N 外键依赖一样）。
如果发现某个 doc 层次过深（超过 2 层），八成得考虑要拆分了，要不然性能和可维护性都会有问题。
按照有表结构的方式来设计

MongoDB 是没有表结构这个概念的，但是实际使用的时候，很少说一个 collection 里面存在各式各样结构的 doc，如果发现 doc 的结构差别越来越大了，那么应该考虑怎么抽象成类似结构，把变化的东西扔到其他 collection 去，用外键依赖的方式互相引用。
比如设计一个用户系统，user collection 应该放 name 等常用的信息，也应该放 lastLoginAt 这些仅跟 user 相关的东西，或许应该把用户有哪些访问权限的信息也放进来，但是不要放用户的登录日志这种信息会不断增加的信息。

至于 user 之间的关系是否存在 user collection 则需要讨论。假如仅仅需要存储用户间的关系，记录下好友的 uid 就行，而且好友数量也不太大，几百个最多了，那么我倾向于放在一个 collection 里。如果关系数据本身就比较复杂，或者好友数会上千，那我倾向于拆分。

另外，Mongodb 官方的 数据模型设计范式 很值得一读，推荐去好好看看。

[Mongodb 数据库表格设计原则](https://www.cnblogs.com/meloncodezhang/p/13883234.html)

## 分库分表的一些关键点

[水平分库分表的关键步骤以及可能遇到的问题](https://www.jianshu.com/p/497b029d3e79)

最后，有很多读者都想了解当前社区中有没有开源免费的分库分表解决方案，毕竟站在巨人的肩膀上能省力很多。当前主要有两类解决方案：

基于应用程序层面的DDAL（分布式数据库访问层）

比较典型的就是淘宝半开源的TDDL，当当网开源的Sharding-JDBC等。分布式数据访问层无需硬件投入，技术能力较强的大公司通常会选择自研或参照开源框架进行二次开发和定制。对应用程序的侵入性一般较大，会增加技术成本和复杂度。通常仅支持特定编程语言平台（Java平台的居多），或者仅支持特定的数据库和特定数据访问框架技术（一般支持MySQL数据库，JDBC、MyBatis、Hibernate等框架技术）。

数据库中间件，比较典型的像mycat（在阿里开源的cobar基础上做了很多优化和改进，属于后起之秀，也支持很多新特性），基于Go语言实现kingSharding，比较老牌的Atlas（由360开源）等。这些中间件在互联网企业中大量被使用。另外，MySQL 5.x企业版中官方提供的Fabric组件也号称支持分片技术，不过国内使用的企业较少。

中间件也可以称为“透明网关”，大名鼎鼎的mysql_proxy大概是该领域的鼻祖（由MySQL官方提供，仅限于实现“读写分离”）。中间件一般实现了特定数据库的网络通信协议，模拟一个真实的数据库服务，屏蔽了后端真实的Server，应用程序通常直接连接中间件即可。而在执行SQL操作时，中间件会按照预先定义分片规则，对SQL语句进行解析、路由，并对结果集做二次计算再最终返回。引入数据库中间件的技术成本更低，对应用程序来讲侵入性几乎没有，可以满足大部分的业务。增加了额外的硬件投入和运维成本，同时，中间件自身也存在性能瓶颈和单点故障问题，需要能够保证中间件自身的高可用、可扩展。

总之，不管是使用分布式数据访问层还是数据库中间件，都会带来一定的成本和复杂度，也会有一定的性能影响。所以，还需读者根据实际情况和业务发展需要慎重考虑和选择。

作者：meng_philip123
链接：https://www.jianshu.com/p/497b029d3e79
来源：简书
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。


# MongoDB vs ES 

https://codeantenna.com/a/FeTFiR34QQ

两者的很大区别在于源数据的存储和管理

MongoDB作为一个数据库产品, 是拥有源数据管理能力的
Elasticsearch作为一个搜索引擎, 定位是提供数据检索服务, 也就是说我只管查, 不管写 _, Elasticsearch的Mapping不可变也是为此服务的, 带来的代价就是es不适合作为数据管理者, es可以从其他数据源同步数据过来提供查询, 但是不适合自己对数据进行存储和管理
es更侧重数据的查询, 各种复杂的花式查询支持的很好, 相比来说 MongoDB的查询能力就显得比较平庸了

由此可见, 对于个人, 如果你有一批数据要看, 但是不经常进行修改, 这个时候毫无疑问可以用es, 但是如果你还打算继续修改数据, 最好就是使用MongoDB，但其实对大多数人公司来讲，这两者的数据管理能力并没有多大的影响


使用mongo-es 
https://zhuanlan.zhihu.com/p/26906652

mongo-connector ,参见https://cloud.tencent.com/developer/article/1157612

使用logstash, 参见 https://www.saoniuhuo.com/question/detail-1987047.html
https://stackoverflow.com/questions/56628675/sync-mongodb-with-elasticsearch


Google、Statckoverflow上充斥着mongdb到elasticsearch同步的文章和问题，而反过来，elasticsearch到mongodb同步的操作做的少之又少。
这也说明了，好的架构设计应该是源数据存储在Mongodb，需要全文检索的时候再同步到ES中进行检索。

